name: bcos-c-sdk GitHub Actions
on:
  push:
    paths-ignore:
      - "docs/**"
      - "Changelog.md"
      - "README.md"
  pull_request:
    paths-ignore:
      - "docs/**"
      - "Changelog.md"
      - "README.md"
  release:
    types: [ published, created, edited ]
env:
  CCACHE_DIR: ${{ github.workspace }}/ccache
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true

jobs:
  build_with_clang:
    name: build_with_clang
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-15-intel, macos-15 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5
      - name: Nightly default
        run: rustup default nightly
      - uses: actions/cache@v4
        id: cache
        with:
          path: |
            /usr/local/share/vcpkg/buildtrees
            /usr/local/share/vcpkg/packages
          key: vcpkg-clang-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
          restore-keys: |
            vcpkg-clang-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
            vcpkg-clang-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-
            vcpkg-clang-v1-notest-${{ runner.temp }}-
      - name: install macOS dependencies
        run: brew install ccache lcov
      - name: install vcpkg (macOS)
        run: |
          if [ ! -f /usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake ]; then
            sudo mkdir -p /usr/local/share
            git clone https://github.com/Microsoft/vcpkg.git /tmp/vcpkg
            sudo cp -r /tmp/vcpkg /usr/local/share/vcpkg
            (cd /usr/local/share/vcpkg && ./bootstrap-vcpkg.sh)
          fi
      - name: configure
        run: |
          export SDKROOT=$(xcrun --sdk macosx --show-sdk-path)
          export CC=/usr/bin/clang
          export CXX=/usr/bin/clang++
          # Ensure make is found by CMake (avoids "CMAKE_MAKE_PROGRAM is not set" after vcpkg)
          export PATH="/usr/bin:$PATH"
          mkdir build && cd build
          cmake ../ -G "Unix Makefiles" -DCMAKE_MAKE_PROGRAM=/usr/bin/make -DCMAKE_C_COMPILER=/usr/bin/clang -DCMAKE_CXX_COMPILER=/usr/bin/clang++ -DBUILD_JNI=ON -DBUILD_SAMPLE=ON -DTESTS=ON -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_OVERLAY_PORTS=${{ github.workspace }}/overlay-ports
      - name: compile
        run: export CFLAGS="${CFLAGS} -fPIC";export CXXFLAGS="${CXXFLAGS} -fPIC"; cd build && make -j4
      - name: run test
        run: cd build && CTEST_OUTPUT_ON_FAILURE=TRUE make test
      - name: print link.txt
        run: cat build/CMakeFiles/bcos-c-sdk*.dir/link.txt
      - name: strip libbcos-c-sdk.dylib
        run: strip build/libbcos-c-sdk.dylib || strip -x build/libbcos-c-sdk.dylib
      - name: strip libbcos-sdk-jni.dylib
        run: |
          ls -h bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.dylib 
          strip bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.dylib || strip -x bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.dylib
          ls -h bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-c-sdk.dylib
          path: build/libbcos-c-sdk.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-sdk-jni.dylib
          path: bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.dylib
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

  build_with_gcc:
    name: build_with_gcc
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-22.04 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5
      - uses: actions/cache@v4
        id: cache
        with:
          path: |
            /usr/local/share/vcpkg/buildtrees
            /usr/local/share/vcpkg/packages
          key: vcpkg-gcc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
          restore-keys: |
            vcpkg-gcc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
            vcpkg-gcc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-
            vcpkg-gcc-v1-notest-${{ runner.temp }}-
      - name: install Ubuntu dependencies
        run: sudo apt install -y git curl openssl build-essential cmake ccache lcov
      - name: configure
        run: |
          export CFLAGS="${CFLAGS} -fPIC";export CXXFLAGS="${CXXFLAGS} -fPIC"; 
          mkdir -p build && cd build 
          cmake  ../ -DBUILD_JNI=ON -DBUILD_SAMPLE=ON -DTESTS=ON -DCOVERAGE=ON -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake
      - name: compile
        run: cd build && make -j4
      - name: run test
        run: cd build && CTEST_OUTPUT_ON_FAILURE=TRUE make test
      - name: print link.txt
        run: cat build/CMakeFiles/bcos-c-sdk*.dir/link.txt
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
      - name: run coverage
        run: cd build && make cov
      - name: upload coverage report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/coverage.info
          flags: unittests
          name: c sdk coverage
          fail_ci_if_error: false
          verbose: true

  build_with_rocky:
    name: build_with_rocky
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container:
          - rocky-8
    container:
      image: rockylinux:8
      volumes:
        - /usr/local/share/vcpkg:/usr/local/share/vcpkg
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5
      - name: install rust language
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: nightly-2024-01-01
      - uses: actions/cache@v4
        id: deps_cache
        with:
          path: |
            deps/
            /usr/local/share/vcpkg/buildtrees
            /usr/local/share/vcpkg/packages
            /home/runner/.ccache
          key: rocky-notest-all-${{ matrix.container }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
          restore-keys: |
            rocky-notest-all-${{ matrix.container }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
            rocky-notest-all-${{ matrix.container }}-${{ github.base_ref }}-
            rocky-notest-all-${{ matrix.container }}-
      - name: install Rocky Linux dependencies
        run: |
          dnf install -y epel-release
          dnf install -y git curl openssl openssl-devel cmake ccache make java-11-openjdk-devel wget zlib-devel libzstd-devel flex bison perl
          # Install GCC 11 toolset (required for -fcoroutines support)
          dnf install -y gcc-toolset-11 gcc-toolset-11-gcc gcc-toolset-11-gcc-c++
      - name: configure
        run: |
          # Enable GCC 11 toolset
          source /opt/rh/gcc-toolset-11/enable
          export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
          export CC=gcc
          export CXX=g++
          gcc --version
          java -version
          export CFLAGS="${CFLAGS} -fPIC"
          export CXXFLAGS="${CXXFLAGS} -fPIC"
          mkdir -p build && cd build
          cmake ../ -DBUILD_JNI=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_SAMPLE=ON -DTESTS=ON -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake
          make -j4
      - name: run test
        run: cd build && CTEST_OUTPUT_ON_FAILURE=TRUE make test
      - name: print link.txt
        run: cat build/CMakeFiles/bcos-c-sdk*.dir/link.txt
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-c-sdk-WithDebInfo.so
          path: build/libbcos-c-sdk.so
      - name: strip libbcos-c-sdk.so
        run: |
          ls -h build/libbcos-c-sdk.so
          strip build/libbcos-c-sdk.so || strip -x build/libbcos-c-sdk.so
          ls -h build/libbcos-c-sdk.so
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-sdk-jni-WithDebInfo.so
          path: bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so
      - name: strip libbcos-sdk-jni.so
        run: |
          ls -h bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so
          strip bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so || strip -x bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so
          ls -h bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-c-sdk.so
          path: build/libbcos-c-sdk.so
      - uses: actions/upload-artifact@v4
        with:
          name: libbcos-sdk-jni.so
          path: bindings/java/jni/src/main/resources/META-INF/native/libbcos-sdk-jni.so
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

  build_with_windows:
    name: build_with_windows
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ windows-2019 ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5
      - uses: actions/cache@v4
        id: cache
        with:
          path: |
            C:\vcpkg\buildtrees
            C:\vcpkg\packages
          key: vcpkg-msvc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
          restore-keys: |
            vcpkg-msvc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-${{ hashFiles('.github/workflows/workflow.yml') }}
            vcpkg-msvc-v1-notest-${{ runner.temp }}-${{ github.base_ref }}-
            vcpkg-msvc-v1-notest-${{ runner.temp }}-
      - name: Add MSbuild to PATH
        uses: microsoft/setup-msbuild@v1.1
      - name: configure
        if: runner.os == 'Windows'
        run: |
          mkdir -p build && cd build 
          cmake  -G "Visual Studio 16 2019" -A x64 ../ -DCMAKE_BUILD_TYPE=Release -DBOOST_USE_WINAPI_VERSION=BOOST_WINAPI_VERSION_WIN7 -D_WIN32_WINNT=0x0601 -DTESTS=ON -DBUILD_JNI=ON -DVCPKG_TARGET_TRIPLET='x64-windows-static' -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake || cat C:\vcpkg\buildtrees\fisco-bcos-cpp-sdk\build-x64-windows-static-dbg-out.log
      - name: compile
        run: cd build && MSBuild bcos-c-sdk.sln /p:Configuration=Release /p:Platform=x64
      - uses: actions/upload-artifact@v4
        with:
          name: bcos-c-sdk.lib
          path: D:\a\bcos-c-sdk\bcos-c-sdk\build\Release\bcos-c-sdk.lib
      - uses: actions/upload-artifact@v4
        with:
          name: bcos-c-sdk.dll
          path: D:\a\bcos-c-sdk\bcos-c-sdk\build\Release\bcos-c-sdk.dll
      - uses: actions/upload-artifact@v4
        with:
          name: bcos-sdk-jni.lib
          path: D:\a\bcos-c-sdk\bcos-c-sdk\bindings\java\jni\src\main\resources\META-INF\native\Release\bcos-sdk-jni.lib
      - uses: actions/upload-artifact@v4
        with:
          name: bcos-sdk-jni.dll
          path: D:\a\bcos-c-sdk\bcos-c-sdk\bindings\java\jni\src\main\resources\META-INF\native\Release\bcos-sdk-jni.dll
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
